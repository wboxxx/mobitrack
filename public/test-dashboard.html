<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Test Automation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .app-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }

        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .app-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .app-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .app-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .flow-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flow-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flow-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .flow-item.selected {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .flow-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .flow-item p {
            color: #666;
            font-size: 0.9em;
        }

        .flow-item .steps-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 117, 125, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .status-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            font-weight: bold;
            color: #333;
        }

        .status-value {
            color: #666;
        }

        .status-value.success {
            color: #28a745;
            font-weight: bold;
        }

        .status-value.error {
            color: #dc3545;
            font-weight: bold;
        }

        .status-value.running {
            color: #ffc107;
            font-weight: bold;
        }

        .log-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info { color: #4fc3f7; }
        .log-entry.success { color: #66bb6a; }
        .log-entry.error { color: #ef5350; }
        .log-entry.warning { color: #ffca28; }

        .variables-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .variables-panel h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .variable-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .variable-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .variable-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .running {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ Test Automation Dashboard</h1>
            <p>Automatisation des tests pour applications e-commerce</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- App Selector -->
            <div class="card">
                <h2>üì± S√©lectionner une application</h2>
                <div class="app-selector" id="appSelector">
                    <!-- Apps will be loaded here -->
                </div>
            </div>

            <!-- Flow Selector -->
            <div class="card">
                <h2>üîÑ S√©lectionner un flow de test</h2>
                <div class="flow-selector" id="flowSelector">
                    <p style="color: #999; text-align: center; padding: 40px;">
                        S√©lectionnez d'abord une application
                    </p>
                </div>
            </div>
        </div>

        <!-- Variables Panel -->
        <div class="card">
            <h2>‚öôÔ∏è Variables du test</h2>
            <div class="variables-panel">
                <h3>Variables personnalis√©es (optionnel)</h3>
                <div id="variablesContainer">
                    <div class="variable-input">
                        <input type="text" placeholder="Nom de la variable (ex: productName)" id="varName">
                        <input type="text" placeholder="Valeur (ex: banane)" id="varValue">
                        <button class="btn btn-secondary" onclick="addVariable()" style="flex: 0 0 auto;">Ajouter</button>
                    </div>
                </div>
                <div id="variablesList" style="margin-top: 15px;"></div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-primary" id="runTestBtn" onclick="runTest()" disabled>
                    ‚ñ∂Ô∏è Lancer le test
                </button>
                <button class="btn btn-secondary" onclick="stopTest()" id="stopTestBtn" disabled>
                    ‚èπÔ∏è Arr√™ter
                </button>
                <button class="btn btn-secondary" onclick="clearLogs()">
                    üóëÔ∏è Effacer les logs
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h2>üìä Statut du test</h2>
            <div class="status-item">
                <span class="status-label">√âtat :</span>
                <span class="status-value" id="testStatus">En attente</span>
            </div>
            <div class="status-item">
                <span class="status-label">Application :</span>
                <span class="status-value" id="currentApp">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Flow :</span>
                <span class="status-value" id="currentFlow">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Progression :</span>
                <span class="status-value" id="progress">0/0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Dur√©e :</span>
                <span class="status-value" id="duration">0s</span>
            </div>

            <h2 style="margin-top: 30px;">üìù Logs du test</h2>
            <div class="log-panel" id="logPanel">
                <div class="log-entry info">Pr√™t √† lancer un test...</div>
            </div>
        </div>
    </div>

    <script>
        let selectedApp = null;
        let selectedFlow = null;
        let testVariables = {};
        let testRunning = false;
        let testStartTime = null;
        let durationInterval = null;

        // Charger les apps au d√©marrage
        async function loadApps() {
            try {
                const response = await fetch('/api/apps');
                const data = await response.json();
                
                const appSelector = document.getElementById('appSelector');
                appSelector.innerHTML = '';
                
                data.apps.forEach(app => {
                    const appCard = document.createElement('div');
                    appCard.className = 'app-card';
                    appCard.innerHTML = `
                        <h3>${app.name}</h3>
                        <p>${app.flowsCount} flows disponibles</p>
                    `;
                    appCard.onclick = () => selectApp(app.key, app.name);
                    appSelector.appendChild(appCard);
                });
                
                addLog('‚úÖ Apps charg√©es: ' + data.apps.length, 'success');
            } catch (error) {
                addLog('‚ùå Erreur chargement apps: ' + error.message, 'error');
            }
        }

        // S√©lectionner une app
        async function selectApp(appKey, appName) {
            selectedApp = appKey;
            document.getElementById('currentApp').textContent = appName;
            
            // Mettre √† jour l'UI
            document.querySelectorAll('.app-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.app-card').classList.add('selected');
            
            // Charger les flows
            await loadFlows(appKey);
            
            addLog(`üì± App s√©lectionn√©e: ${appName}`, 'info');
        }

        // Charger les flows d'une app
        async function loadFlows(appKey) {
            try {
                const response = await fetch(`/api/apps/${appKey}/flows`);
                const data = await response.json();
                
                const flowSelector = document.getElementById('flowSelector');
                flowSelector.innerHTML = '';
                
                if (Object.keys(data.flows).length === 0) {
                    flowSelector.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Aucun flow disponible</p>';
                    return;
                }
                
                for (const [key, flow] of Object.entries(data.flows)) {
                    const flowItem = document.createElement('div');
                    flowItem.className = 'flow-item';
                    flowItem.innerHTML = `
                        <h4>${flow.name}</h4>
                        <p>${flow.steps.length} √©tapes</p>
                        <span class="steps-count">${flow.steps.length} √©tapes</span>
                    `;
                    flowItem.onclick = () => selectFlow(key, flow.name);
                    flowSelector.appendChild(flowItem);
                }
                
                addLog(`üîÑ Flows charg√©s: ${Object.keys(data.flows).length}`, 'success');
            } catch (error) {
                addLog('‚ùå Erreur chargement flows: ' + error.message, 'error');
            }
        }

        // S√©lectionner un flow
        function selectFlow(flowKey, flowName) {
            selectedFlow = flowKey;
            document.getElementById('currentFlow').textContent = flowName;
            
            // Mettre √† jour l'UI
            document.querySelectorAll('.flow-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.flow-item').classList.add('selected');
            
            // Activer le bouton de test
            document.getElementById('runTestBtn').disabled = false;
            
            addLog(`üîÑ Flow s√©lectionn√©: ${flowName}`, 'info');
        }

        // Ajouter une variable
        function addVariable() {
            const name = document.getElementById('varName').value.trim();
            const value = document.getElementById('varValue').value.trim();
            
            if (!name || !value) {
                addLog('‚ö†Ô∏è Nom et valeur requis pour la variable', 'warning');
                return;
            }
            
            testVariables[name] = value;
            updateVariablesList();
            
            document.getElementById('varName').value = '';
            document.getElementById('varValue').value = '';
            
            addLog(`‚öôÔ∏è Variable ajout√©e: ${name} = ${value}`, 'info');
        }

        // Mettre √† jour la liste des variables
        function updateVariablesList() {
            const list = document.getElementById('variablesList');
            list.innerHTML = '';
            
            for (const [name, value] of Object.entries(testVariables)) {
                const varItem = document.createElement('div');
                varItem.style.cssText = 'background: white; padding: 10px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;';
                varItem.innerHTML = `
                    <span><strong>${name}:</strong> ${value}</span>
                    <button onclick="removeVariable('${name}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Supprimer</button>
                `;
                list.appendChild(varItem);
            }
        }

        // Supprimer une variable
        function removeVariable(name) {
            delete testVariables[name];
            updateVariablesList();
            addLog(`üóëÔ∏è Variable supprim√©e: ${name}`, 'info');
        }

        // Lancer le test
        async function runTest() {
            if (!selectedApp || !selectedFlow) {
                addLog('‚ùå S√©lectionnez une app et un flow', 'error');
                return;
            }
            
            testRunning = true;
            testStartTime = Date.now();
            
            document.getElementById('runTestBtn').disabled = true;
            document.getElementById('stopTestBtn').disabled = false;
            document.getElementById('testStatus').textContent = 'En cours...';
            document.getElementById('testStatus').className = 'status-value running';
            
            // D√©marrer le compteur de dur√©e
            durationInterval = setInterval(updateDuration, 1000);
            
            addLog('üöÄ Lancement du test...', 'info');
            addLog(`üì± App: ${selectedApp}`, 'info');
            addLog(`üîÑ Flow: ${selectedFlow}`, 'info');
            addLog(`‚öôÔ∏è Variables: ${JSON.stringify(testVariables)}`, 'info');
            
            try {
                const response = await fetch('/api/run-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app: selectedApp,
                        flow: selectedFlow,
                        variables: testVariables
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('‚úÖ Test termin√© avec succ√®s!', 'success');
                    document.getElementById('testStatus').textContent = 'Succ√®s';
                    document.getElementById('testStatus').className = 'status-value success';
                } else {
                    addLog('‚ùå Test √©chou√©: ' + result.error, 'error');
                    document.getElementById('testStatus').textContent = '√âchec';
                    document.getElementById('testStatus').className = 'status-value error';
                }
                
                document.getElementById('progress').textContent = `${result.stepsCompleted}/${result.totalSteps}`;
                
            } catch (error) {
                addLog('‚ùå Erreur: ' + error.message, 'error');
                document.getElementById('testStatus').textContent = 'Erreur';
                document.getElementById('testStatus').className = 'status-value error';
            } finally {
                testRunning = false;
                document.getElementById('runTestBtn').disabled = false;
                document.getElementById('stopTestBtn').disabled = true;
                clearInterval(durationInterval);
            }
        }

        // Arr√™ter le test
        function stopTest() {
            addLog('‚èπÔ∏è Arr√™t du test demand√©...', 'warning');
            // TODO: Impl√©menter l'arr√™t du test
        }

        // Mettre √† jour la dur√©e
        function updateDuration() {
            if (testStartTime) {
                const duration = Math.floor((Date.now() - testStartTime) / 1000);
                document.getElementById('duration').textContent = duration + 's';
            }
        }

        // Ajouter un log
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Effacer les logs
        function clearLogs() {
            document.getElementById('logPanel').innerHTML = '<div class="log-entry info">Logs effac√©s...</div>';
        }

        // Charger les apps au d√©marrage
        loadApps();
    </script>
</body>
</html>
